---
title: "Examen_I_G2 - C33973  Cristhian Jimenez"
author: "Cristhian Jimenez"
format:
  html:
    embed-resources: true
editor: visual
---

```{r}
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("tidyr")
#install.packages("readr")
#install.packages("rpart")
#install.packages("rpart.plot")

library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
library(rpart)
library(rpart.plot)

```

```{r}
#cargar datos
moras <- read_delim("moras.txt", delim = ",")
```

2.(r) Realice un resumen de 5 números incluyendo el promedio. Para las columnas numéricas

```{r}
Estadistica_EDAD <- moras %>% 
  summarise(
    EDAD_min = min(EDAD, na.rm = TRUE),
    EDAD_Q1 = quantile(moras$EDAD, 0.25, na.rm = TRUE),
    EDAD_mediana = median(EDAD, na.rm = TRUE),
    EDAD_Q3 = quantile(moras$EDAD, 0.75, na.rm = TRUE),
    EDAD_max = max(EDAD, na.rm = TRUE),
    SALARIO_media = mean(EDAD, na.rm = TRUE)
)
Estadistica_SALARIO <- moras %>% 
  summarise(
    SALARIO_min = min(SALARIO, na.rm = TRUE),
    SALARIO_Q1 = quantile(moras$SALARIO, 0.25, na.rm = TRUE),
    SALARIO_mediana = median(SALARIO, na.rm = TRUE),
    SALARIO_Q3 = quantile(moras$SALARIO, 0.75, na.rm = TRUE),
    SALARIO_max = max(SALARIO, na.rm = TRUE),
    SALARIO_media = mean(SALARIO, na.rm = TRUE),
)
Estadistica_EDAD
Estadistica_SALARIO
```

3.(r) Realice una columna donde se identifiquen valores atípicos haciendo uso del Z-Score, de tal manera que si el valor absoluto del Z-Score es mayor a 1,96 se considera un valor atípico. Esto para la columna de salario y edad.

```{r}
## Z-Score para salario
promedio_salario <- mean(moras$SALARIO, na.rm = TRUE)
desviacion_estandar_salario <- sd(moras$SALARIO, na.rm = TRUE)
Z_SALARIO <- (moras$SALARIO - promedio_salario) / desviacion_estandar_salario

promedio_EDAD <- mean(moras$EDAD, na.rm = TRUE)
desviacion_estandar_EDAD <- sd(moras$EDAD, na.rm = TRUE)
Z_EDAD <- (moras$EDAD - promedio_EDAD)/ desviacion_estandar_EDAD

moras$ATIPICO_SALARIO <- "Atípico" 
moras$ATIPICO_SALARIO[abs(Z_SALARIO) > 1.96] <- "Normal"

moras$ATIPICO_EDAD <- "Atípico"  
moras$ATIPICO_EDAD[abs(Z_EDAD) > 1.96] <- "Normal"
```

4.(r) Detecte el porcentaje de valores faltantes en cada una de las columnas.

```{r}
for (columna in names(moras)) {
  contar_na <- sum(is.na(moras[[columna]]))
  porcentaje <- round((contar_na / nrow(moras)) * 100, 2)
  cat("-", columna, ":", porcentaje, "% de NA\n")
  }
```

5.(r) Impute los valores faltantes haciendo uso de algún método de su preferencia.

```{r}
moras$EDAD[is.na(moras$EDAD)] <- mean(moras$EDAD, na.rm = TRUE)
moras$SALARIO[is.na(moras$SALARIO)] <- mean(moras$SALARIO, na.rm = TRUE)
moras$TIPO_ASEGURAMIENTO[is.na(moras$TIPO_ASEGURAMIENTO)] <- "DESCONOCIDO"
```

6.(r) Realice gráficos donde se vea la cantidad de individuos por cada categoría

```{r}
ggplot(moras, aes(x = SEXO)) +
  geom_bar(fill = "brown", color = "black") +
  labs(title = "Cantidad de Individuos por SEXO",
       x = "SEXO", 
       y = "Cantidad") +
  theme_minimal()
```

Se puede ver que nuestros datos tiene más hombres que mujeres

```{r}
ggplot(moras, aes(x = SALARIO)) +
  geom_bar(fill = "brown", color = "black") +
  labs(title = "Cantidad de Individuos por SALARIO",
       x = "SALARIO", 
       y = "Cantidad") +
  theme_minimal()
```

Se puede ver que en algunos casos, los salario son bastantes grande en comparación con los demás, note que tiene un cero de más en cada columna, entonces para la comprensión solo se tiene que eliminar uno, no son 5 millones, sino 500 mil y así

```{r}
ggplot(moras, aes(x = SECTOR)) +
  geom_bar(fill = "brown", color = "black") +
  labs(title = "Cantidad de Individuos por SECTOR",
       x = "SECTOR", 
       y = "Cantidad") +
  theme_minimal()
```

En esta se puede ver como hay más personas del sector privado que del público

```{r}
ggplot(moras, aes(x = INDICADOR_ACTIVO)) +
  geom_bar(fill = "brown", color = "black") +
  labs(title = "Cantidad de Individuos por INDICADOR_ACTIVO",
       x = "INDICADOR_ACTIVO", 
       y = "Cantidad") +
  theme_minimal()
```

Se puede ver como todos estan activos

```{r}
ggplot(moras, aes(x = INDICADOR_MOROSO)) +
  geom_bar(fill = "brown", color = "black") +
  labs(title = "Cantidad de Individuos por INDICADOR_ACTIVO",
       x = "INDICADOR_ACTIVO", 
       y = "Cantidad") +
  theme_minimal()
```

se puede ver que la mayoria de las personas si van pagando sus cuotas y que no son morosos pero que si hay morosidad

```{r}
ggplot(moras, aes(x = EDAD)) +
  geom_bar(fill = "brown", color = "black") +
  labs(title = "Cantidad de Individuos por INDICADOR_ACTIVO",
       x = "SEXO", 
       y = "Cantidad") +
  theme_minimal()
```

Se puede ver como se distribuyo las edades de las personas y que la mayor cantida esta entre los 25 y los 45

7.  (Excel) Realice un gráfico para cada una de las variables categóricas en donde se vea el porcentaje de personas morosa por cada clase. Analice los resultados.

```{r}
variables_categoricas <- c("SEXO", "TIPO_ASEGURAMIENTO", "SECTOR", "INDICADOR_ACTIVO", "INDICADOR.EXTRANJERO")

calcular_morosidad <- function(variable) {
  moras %>%
    group_by(!!sym(variable)) %>%
    summarise(
      total = n(),
      morosos = sum(INDICADOR_MOROSO == "SI"),
      porcentaje_morosidad = (morosos / total) * 100
    ) %>%
    mutate(variable = variable)
}

resultados <- lapply(variables_categoricas, calcular_morosidad) %>%
  bind_rows()

for (variable in variables_categoricas) {
  datos_grafico <- resultados %>% 
    filter(variable == !!variable)
  
  p <- ggplot(datos_grafico, aes(x = !!sym(variable), y = porcentaje_morosidad, fill = !!sym(variable))) +
    geom_bar(stat = "identity", alpha = 0.8) +
    geom_text(aes(label = sprintf("%.1f%%", porcentaje_morosidad)), 
              vjust = -0.5, size = 3.5) +
    labs(
      title = paste("% Morosidad por", variable),
      x = variable,
      y = "% Morosos"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none"
    ) +
    scale_fill_manual(values = rep("brown", nrow(datos_grafico))) +  
    ylim(0, max(datos_grafico$porcentaje_morosidad) * 1.1)
  
  print(p)
}
```

8.(r) Para las variables numéricas realice gráficos de barras donde se ponga un color de acuerdo a si es moroso o no. Analice los resultados.

```{r}
# Crear los rangos de salario y edad
moras <- moras %>%
  mutate(
    RANGO_EDAD = cut(EDAD,
                     breaks = c(0, 25, 35, 45, 55, 65, 100),
                     labels = c("18-25", "26-35", "36-45", "46-55", "56-65", "65+"),
                     include.lowest = TRUE),
    
    RANGO_SALARIO = ifelse(is.na(SALARIO) | SALARIO == "", "Sin Dato",
                          cut(as.numeric(SALARIO),
                              breaks = c(0, 500000, 1000000, 2000000, 3000000, Inf),
                              labels = c("0-500000", "500000-1000000", "1000000-2000000", "2000000-3000000", "3000000+"),
                              include.lowest = TRUE))
  )

variables_numericas <- c("RANGO_EDAD", "RANGO_SALARIO")

calcular_morosidad <- function(variable) {
  moras %>%
    group_by(!!sym(variable)) %>%
    summarise(
      total = n(),
      morosos = sum(INDICADOR_MOROSO == "SI"),
      porcentaje_morosidad = (morosos / total) * 100
    ) %>%
    mutate(variable = variable) %>%
    rename(categoria = !!sym(variable)) %>%   
    mutate(categoria = as.character(categoria))
}

resultados <- lapply(variables_numericas, calcular_morosidad) %>%
  bind_rows()

for (variable in variables_numericas) {
  datos_grafico <- resultados %>% filter(variable == !!variable)
  
  p <- ggplot(datos_grafico, aes(x = categoria, y = porcentaje_morosidad, fill = categoria)) +
    geom_bar(stat = "identity", alpha = 0.8) +
    geom_text(aes(label = sprintf("%.1f%%", porcentaje_morosidad)), 
              vjust = -0.5, size = 3.5) +
    labs(
      title = paste("% Morosidad por", variable),
      x = variable,
      y = "% Morosos"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none"
    ) +
    scale_fill_brewer(palette = "Set3") +
    ylim(0, max(datos_grafico$porcentaje_morosidad, na.rm = TRUE) * 1.1)
  
  print(p)
}
```

9.(r) Replique lo anterior, items 2-8, en el lenguaje de programación R y haga uso de Git, agregue un .gitignore conveniente. Cada vez que termine un punto realice un commit. El commit final debe ser el punto que se muestra a continuación. Usar commits convencionales. repositorio https://github.com/Cristhian892/Examen-II-virtual.git nota: se me olvido hacer los commit, los hice cuando termine hasta el punto 8 por estan segudos, el punto 10 cuando realice los commit de subida del 2-8 no lo e realio

10. Se busca encontrar cuáles son las variables que podrían tener mayor relación con que la persona sea morosa o no, para ello se decide realizar un árbol de decisión por su interpretabilidad y su fácil explicación a los altos mandos. A continuación se adjunta un código ejemplo de cómo se construye un árbol y cómo se muestra \$ #\| eval: false \$ library(rpart) \$ library(rpart.plot) \$ tree \<- rpart(y\~., data = df) \$ rpart.plot(tree) En este caso la variable y es la variable que se quiere explicar con las otras y . indica que se usen todas las variables, recuerde eliminar el identificador único del df. Podría requerir codificar de una manera diferente algunas clases en las variables categóricas, esto para una mejor visualización. Explique los resultados del árbol para alguien que no tiene tanta formación cuantitativa y busca tomar decisiones con base en sus resultados.

```{r}
moras_menos_IDENTIFICACION <- moras %>% 
  select(-IDENTIFICACION)

moras_factores <-  moras_menos_IDENTIFICACION %>% 
  mutate_if(is.character, as.factor)
tree <- rpart(INDICADOR_MOROSO ~., data = moras_factores)
rpart.plot(tree)
```

El árbol nos ayuda a observar cuáles son las variables que tienen un mayor peso para detectar si alguien será moroso. En el árbol se ve como los trabajadores independientes son de gran riesgo en volverse morosos, los que son asegurados voluntarios presentan un riesgo moderado y los asalariados son de menor riesgo. Las personas con salarios bajaos son más propensos a quedar morosos y cuando aumenta el salario el riesgo de morosidad empieza a disminuir. Ahora viendo el sector, vemos que el sector privado tiene mayor probabilidad de ser morosos que los del sector público y con base a la edad entre más joven más propenso a ser moroso y entre más edad este riesgo baja.

Bibliografica *https://www.simplypsychology.org/z-score.html* https://www.statisticshowto.com/probability-and-statistics/z-score/ \*https://www-spsanderson-com.translate.goog/steveondata/posts/2024-12-03/?\_x_tr_sl=en&\_x_tr_tl=es&\_x_tr_hl=es&\_x_tr_pto=tc
